language: android
services:
  - docker
jdk: oraclejdk8

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - "$HOME/.gradle/caches/"
    - "$HOME/.gradle/wrapper/"
    - "$HOME/.android/build-cache"
env:
  global:
    - ANDROID_API_LEVEL_TARGET=28
    - ANDROID_API_LEVEL_EMULATOR=21
    - ANDROID_BUILD_TOOLS_VERSION=28.0.3
    - CMAKE_VERSION=3.6.4111459
    - LLDB_VERSION=3.0
    - secure: "OghVEWM06zyOFuO3RqLZFuqBxkbeUNKI4w4jZzk+/GsZry7Vp1iuX8K2gqGlHKtocy6/fS9dXzfuPr7xHPXBckEqnAwkvQTro4T4X7qv/+SSVKM+GjWJ0emMSikH7PcFDnSOvDZb4pEBacDLhEQtmz0KW3hK/nxreAVsjCGLeF0LXAwxbzoPvpC7u6yB/aZC6B19S+IQb1nF774iQXKeaOrcLOleRQEeVHIv+ohu1Nht3sNq81TaGOBVJcYw0sChqdWR7U5Nt8D/pbLkYm+7Weu1/ES87A7v4/qARGhLj1jz/ASrb9PMpNWt8M36K7826dzmYxqregqIjlmaB/CxfvbdLO4VCSiNO3fA9rH/2M/s7OT4LbyG+kBASkN8bCdOZuIRr6UH+iwIWK9+dWNhw+DnWjWWfEhZiTwPOLkbTSUe/k1NAerMlD0D/VL4IOtgeYDmCF/OiPPGmziodZkZWBvd5CLm3YPD/it4S2bugK3nM8+L+3ZQA16wF2rq0eAjzTgkUZe85rwwt1P0XA0eb9++D9HP1Aqh5zPwzJUef9W4opiZC2hgDn9PDciRyp91mGlCfx4qGt6xALOS/D0vFhJZsNfZqI0m8jfaB8apvZ30WC39ZhDX6HIOXzSxTjdP1J+VFMI7MarOlKX983IdSSskUEGJ8WCZWYex5I+6M3Y="
    - secure: "LmLD3HBadbGLkmZ6FRLIlCQG5fAHnidkC6brZ4WJVM99FwKB3jsPItnx+mQmT1cClMLqhm5LHIoD1VZpKxMSdvtXLgzZNhZ9ZjNEToB2ogegwO32ooYYgNenGfVUITL2gTxBCMRXuw+Ufrt2vPpoXxRR/uokgoPJ/wUzyQ555jOX5imAHzpYL4jiqmAiJ5jmQlwjZ0B6cjeY3aYwa48EIedf0m6frwPQq6ccmxBCcY5qO6/tt36ssIqaAlWuveYLa/z9ety/TeyeeatL/OY87kWwy/hCk1WM6KlQsWjKwDTUXMVc5UGwZES5N2wjxEQr/Rmrm5WFv5Zj67LCUWE7mtc61DsyxtIfvUhdboOveb/5V7pKu3+e6Ot/uqFp8DqapZ3K8FIXcmRvDS5NaBxn4MYsMYiCZB0Kmi+s1mja9s6bw5UkJEy8smwDkgjgbs7QB8AY+AJGcX3ZbsTlsCBlqKqFIcqBHqNHlg3Gxkl3Ohr6tdDMJjU6bn2waJDGjOcgKokUW/EeQmk5Bs1xMiabWJpu8LIdeNGf7bRGrlaiNoY62cMAp9mmdyPF4dSStEGbZSKf+1iMwoBDn5Eg/8l/7pDa2M/5hbx06jkxkcXzFRRTb8LHj/bSWsFp/e8uMjCxjQQI5W0+imWU6H0uWggY0KIGyW+U0123XUZT5XTNXds="

before_install:
  - openssl aes-256-cbc -K $encrypted_b7a1826936eb_key -iv $encrypted_b7a1826936eb_iv
    -in keystore.jks.enc -out keystore.jks -d

install:
  - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh;
  - bash miniconda.sh -b -p $HOME/miniconda
  - export PATH="$HOME/miniconda/bin:$PATH"
  - export PATH="$PWD/build:$PATH"
  - conda info -a
  - source activate base
  - conda install -y -c conda-forge meson ninja
  - echo "y" | sdkmanager "ndk-bundle"
  - echo "y" | sdkmanager "cmake;$CMAKE_VERSION"
  - echo "y" | sdkmanager "lldb;$LLDB_VERSION"

android:
  components:
  - build-tools-$ANDROID_BUILD_TOOLS_VERSION
  - android-$ANDROID_API_LEVEL_EMULATOR
  - android-$ANDROID_API_LEVEL_TARGET
  - extra-google-google_play_services
  - extra-google-m2repository
  - extra-android-m2repository
  - sys-img-armeabi-v7a-android-$ANDROID_API_LEVEL_EMULATOR

before_script:
  - bash before_operations.sh

script:
  - bash update_fakeinput_jar_asset.sh
  - bash build_operations.sh

before_deploy:
  - cp $TRAVIS_BUILD_DIR/.keystore $HOME

  - cd app/build/outputs/apk/release
  - jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore $HOME/keystore.jks
    -storepass $storepass -keypass $keypass app-release-unsigned.apk flyinnkey
  - jarsigner -verify app-release-unsigned.apk
  - "${ANDROID_HOME}/build-tools/24.0.2/zipalign -v 4 app-release-unsigned.apk flyinn-client.apk"

  - cd server/build/outputs/apk/release
  - jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore $HOME/keystore.jks
    -storepass $storepass -keypass $keypass server-release-unsigned.apk flyinnkey
  - jarsigner -verify server-release-unsigned.apk
  - "${ANDROID_HOME}/build-tools/24.0.2/zipalign -v 4 server-release-unsigned.apk flyinn-server.apk"

deploy:
  provider: releases
  api_key:
    secure: "ZiWMeEJKwD4WHsT5d4qUy0EnX9idTpKDqEtOdqJ8+tHbjQTeNj9lANrvNJsnKpNZIFro1E6TjsC/HHlHe0XLwHop0AAe37E9iPjoWqy5DnTp1JvUStFMVNfIkLXNcUsCXPWc0XkMqA/S1Pz/6oEPvLa5LvkFvx3CKvoQt0Diadj50FQG8Dn0IA0y+zKmPoY96CdgFZdTB+xBsp8TEVpzacYh2TeNbNvd0ZCDMqjfORJHHsyDXTIYlINNRd9XI+ugNQfYVoaf8IYjAEfj9oS2SZ9u3CYG+y/brvJla3WmJV91F3E4yKVo2Yw6bXoEJJdHxdJVj8ODOUmpyMdB0RbTMDP2+UEVVTAE6ZPYQ/GyDhB4gkgTVgypd2C/ZV6IPAtLdw9qX6AojIjnUzHLXqK9gPSgMuRvcvxCdgXpQnRrX1oi+9MXTfBCy+BJL0vFbAwynSfKVdaMOUOAygH7m0Fpy2kVfXgT6CwcTHYDZqnTPYRD2dKF3w/wI+SD+nZhMifRXXj9MnypYm+/id3k816RmSBgOum9Ebotw7jJiriILa/aXxIUajxF7jbQK4wfLWnmtIZZ4mYvemM71f1+DjY+crJ4MFg9RDTOKuDWfcfKRomyEqqUv5PVPqL03aA2hSniowv6sYRrC5ySaOVUOCNGGf2Ks+PF1PYBZpJ2byeNp8U="
  file:
    - flyinn-client.apk
    - flyinn-server.apk
  skip_cleanup: true
  on:
    repo: amos-flyinn/amos-tub-ws18-proj1
    tags: true
